#!/usr/bin/env bash
set -e

# Dabira Agent Installation Script
# This script downloads and installs the Dabira Agent CLI

# Configuration
REPO="dabira/agent-server"  # Your private repo
BINARY_NAME="dabira-agent"
INSTALL_DIR="/usr/local/bin"
GITHUB_API="https://api.github.com"
GITHUB_DOWNLOAD="https://github.com"

# Colors for output
if [ -t 1 ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    MAGENTA='\033[0;35m'
    CYAN='\033[0;36m'
    BOLD='\033[1m'
    NC='\033[0m' # No Color
else
    RED=''
    GREEN=''
    YELLOW=''
    BLUE=''
    MAGENTA=''
    CYAN=''
    BOLD=''
    NC=''
fi

# Functions
print_banner() {
    echo ""
    echo "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo "${CYAN}â•‘${NC}                                                        ${CYAN}â•‘${NC}"
    echo "${CYAN}â•‘${NC}  ${BOLD}${MAGENTA}Dabira Agent Installer${NC}                             ${CYAN}â•‘${NC}"
    echo "${CYAN}â•‘${NC}  Secure database proxy for AI-powered analytics   ${CYAN}â•‘${NC}"
    echo "${CYAN}â•‘${NC}                                                        ${CYAN}â•‘${NC}"
    echo "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

print_step() {
    echo ""
    echo "${BLUE}==>${NC} ${BOLD}$1${NC}"
}

print_success() {
    echo "${GREEN}âœ“${NC} $1"
}

print_error() {
    echo "${RED}âœ— Error:${NC} $1" >&2
}

print_warning() {
    echo "${YELLOW}âš  Warning:${NC} $1"
}

print_info() {
    echo "${CYAN}â„¹${NC} $1"
}

# Detect platform
detect_platform() {
    local os arch
    
    os=$(uname -s | tr '[:upper:]' '[:lower:]')
    arch=$(uname -m)
    
    case "$os" in
        linux)
            OS_TYPE="linux"
            ;;
        darwin)
            OS_TYPE="macos"
            ;;
        mingw*|msys*|cygwin*)
            OS_TYPE="windows"
            ;;
        *)
            print_error "Unsupported operating system: $os"
            echo "Supported: Linux, macOS, Windows"
            exit 1
            ;;
    esac
    
    case "$arch" in
        x86_64|amd64)
            ARCH_TYPE="x86_64"
            ;;
        aarch64|arm64)
            ARCH_TYPE="aarch64"
            ;;
        *)
            print_error "Unsupported architecture: $arch"
            echo "Supported: x86_64, aarch64"
            exit 1
            ;;
    esac
    
    # Construct download filename
    if [ "$OS_TYPE" = "windows" ]; then
        DOWNLOAD_FILE="${BINARY_NAME}-${OS_TYPE}-${ARCH_TYPE}.exe"
    else
        DOWNLOAD_FILE="${BINARY_NAME}-${OS_TYPE}-${ARCH_TYPE}"
    fi
    
    print_info "Detected platform: ${BOLD}${OS_TYPE} ${ARCH_TYPE}${NC}"
}

# Check requirements
check_requirements() {
    local missing_tools=()
    
    if ! command -v curl &> /dev/null; then
        missing_tools+=("curl")
    fi
    
    if ! command -v shasum &> /dev/null && ! command -v sha256sum &> /dev/null; then
        missing_tools+=("shasum or sha256sum")
    fi
    
    if [ ${#missing_tools[@]} -ne 0 ]; then
        print_error "Missing required tools: ${missing_tools[*]}"
        echo ""
        echo "Please install the missing tools:"
        
        if [ "$OS_TYPE" = "linux" ]; then
            echo "  sudo apt-get install curl coreutils"
        elif [ "$OS_TYPE" = "macos" ]; then
            echo "  brew install curl coreutils"
        fi
        
        exit 1
    fi
}

# Get latest version from GitHub
get_latest_version() {
    print_step "Fetching latest version..."
    
    local api_url="${GITHUB_API}/repos/${REPO}/releases/latest"
    local response
    
    response=$(curl -fsSL "$api_url" 2>&1) || {
        print_error "Failed to fetch release information"
        print_info "API URL: $api_url"
        echo "$response" >&2
        exit 1
    }
    
    VERSION=$(echo "$response" | grep '"tag_name":' | sed -E 's/.*"tag_name": *"([^"]+)".*/\1/')
    
    if [ -z "$VERSION" ]; then
        print_error "Could not determine latest version"
        exit 1
    fi
    
    print_success "Latest version: ${BOLD}${VERSION}${NC}"
}

# Check if already installed
check_existing() {
    if command -v "$BINARY_NAME" &> /dev/null; then
        local existing_version
        existing_version=$("$BINARY_NAME" --version 2>/dev/null | head -n1 || echo "unknown")
        
        print_warning "Dabira Agent is already installed: ${existing_version}"
        echo ""
        read -p "Do you want to reinstall/upgrade? (y/N) " -n 1 -r
        echo ""
        
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_info "Installation cancelled"
            exit 0
        fi
    fi
}

# Download binary
download_binary() {
    print_step "Downloading Dabira Agent ${VERSION}..."
    
    DOWNLOAD_URL="${GITHUB_DOWNLOAD}/${REPO}/releases/download/${VERSION}/${DOWNLOAD_FILE}"
    CHECKSUM_URL="${GITHUB_DOWNLOAD}/${REPO}/releases/download/${VERSION}/${DOWNLOAD_FILE}.sha256"
    
    TEMP_DIR=$(mktemp -d)
    TEMP_FILE="${TEMP_DIR}/${BINARY_NAME}"
    CHECKSUM_FILE="${TEMP_DIR}/${DOWNLOAD_FILE}.sha256"
    
    print_info "Downloading from: ${DOWNLOAD_URL}"
    
    if ! curl -fL --progress-bar "$DOWNLOAD_URL" -o "$TEMP_FILE"; then
        print_error "Failed to download binary"
        print_info "Please check if the release exists: https://github.com/${REPO}/releases"
        rm -rf "$TEMP_DIR"
        exit 1
    fi
    
    # Download checksum
    if curl -fsSL "$CHECKSUM_URL" -o "$CHECKSUM_FILE" 2>/dev/null; then
        print_info "Verifying checksum..."
        
        local expected_checksum
        expected_checksum=$(cat "$CHECKSUM_FILE")
        
        local actual_checksum
        if command -v sha256sum &> /dev/null; then
            actual_checksum=$(sha256sum "$TEMP_FILE" | awk '{print $1}')
        else
            actual_checksum=$(shasum -a 256 "$TEMP_FILE" | awk '{print $1}')
        fi
        
        if [ "$expected_checksum" = "$actual_checksum" ]; then
            print_success "Checksum verified"
        else
            print_error "Checksum verification failed!"
            echo "Expected: $expected_checksum"
            echo "Got:      $actual_checksum"
            rm -rf "$TEMP_DIR"
            exit 1
        fi
    else
        print_warning "Could not download checksum file, skipping verification"
    fi
    
    # Verify download
    if [ ! -s "$TEMP_FILE" ]; then
        print_error "Downloaded file is empty"
        rm -rf "$TEMP_DIR"
        exit 1
    fi
    
    chmod +x "$TEMP_FILE"
    print_success "Download complete"
}

# Install binary
install_binary() {
    print_step "Installing to ${INSTALL_DIR}..."
    
    # Create install directory if it doesn't exist
    if [ ! -d "$INSTALL_DIR" ]; then
        print_info "Creating directory: $INSTALL_DIR"
        sudo mkdir -p "$INSTALL_DIR"
    fi
    
    # Check if we need sudo
    if [ -w "$INSTALL_DIR" ]; then
        mv "$TEMP_FILE" "$INSTALL_DIR/$BINARY_NAME"
    else
        print_info "Requesting sudo permission for installation..."
        sudo mv "$TEMP_FILE" "$INSTALL_DIR/$BINARY_NAME"
        sudo chmod +x "$INSTALL_DIR/$BINARY_NAME"
    fi
    
    # Clean up
    rm -rf "$TEMP_DIR"
    
    # Verify installation
    if [ ! -f "$INSTALL_DIR/$BINARY_NAME" ]; then
        print_error "Installation failed - binary not found"
        exit 1
    fi
    
    print_success "Installation complete"
}

# Verify installation
verify_installation() {
    print_step "Verifying installation..."
    
    if ! command -v "$BINARY_NAME" &> /dev/null; then
        print_warning "Binary installed but not in PATH"
        echo ""
        echo "Add ${INSTALL_DIR} to your PATH:"
        echo "  export PATH=\"${INSTALL_DIR}:\$PATH\""
        echo ""
        echo "Add this to your shell profile (~/.bashrc, ~/.zshrc, etc.)"
        return 1
    fi
    
    local installed_version
    installed_version=$("$BINARY_NAME" --version 2>/dev/null | head -n1)
    
    print_success "Installed: ${BOLD}${installed_version}${NC}"
    return 0
}

# Print next steps
print_next_steps() {
    echo ""
    echo "${GREEN}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo "${GREEN}${BOLD}â•‘  Installation Successful! ğŸ‰                           â•‘${NC}"
    echo "${GREEN}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "${BOLD}Next Steps:${NC}"
    echo ""
    echo "  ${CYAN}1.${NC} Configure your agent:"
    echo "     ${BOLD}$ dabira-agent setup${NC}"
    echo ""
    echo "  ${CYAN}2.${NC} Check agent status:"
    echo "     ${BOLD}$ dabira-agent status${NC}"
    echo ""
    echo "  ${CYAN}3.${NC} View available commands:"
    echo "     ${BOLD}$ dabira-agent --help${NC}"
    echo ""
    echo "${BOLD}Documentation:${NC}"
    echo "  https://docs.dabira.com/agent"
    echo ""
    echo "${BOLD}Get Support:${NC}"
    echo "  â€¢ GitHub Issues: https://github.com/${REPO}/issues"
    echo "  â€¢ Email: support@dabira.com"
    echo ""
}

# Main installation flow
main() {
    print_banner
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --version)
                VERSION="$2"
                shift 2
                ;;
            --help)
                echo "Usage: install.sh [OPTIONS]"
                echo ""
                echo "Options:"
                echo "  --version VERSION    Install specific version (e.g., v1.0.0)"
                echo "  --help               Show this help message"
                echo ""
                echo "Example:"
                echo "  curl -fsSL https://install.dabira.com/install.sh | bash"
                echo "  curl -fsSL https://install.dabira.com/install.sh | bash -s -- --version v1.0.0"
                exit 0
                ;;
            *)
                print_error "Unknown option: $1"
                echo "Use --help for usage information"
                exit 1
                ;;
        esac
    done
    
    # Run installation steps
    detect_platform
    check_requirements
    check_existing
    
    if [ -z "$VERSION" ]; then
        get_latest_version
    else
        print_info "Installing version: ${BOLD}${VERSION}${NC}"
    fi
    
    download_binary
    install_binary
    
    if verify_installation; then
        print_next_steps
    else
        echo ""
        echo "Installation completed with warnings."
        echo "You may need to update your PATH as shown above."
    fi
}

# Run main function
main "$@"